import{h as D,I as b}from"./client-D6K6htDN.js";import{I as ee}from"./types-CpYKjTMI.js";import{_ as te}from"./EmptyState.vue_vue_type_script_setup_true_lang-BdG-MbLV.js";import{S as C}from"./StatCard-B99VHW3b.js";import{_ as R}from"./Badge.vue_vue_type_script_setup_true_lang-CWRgq3ED.js";import{_ as O}from"./Button.vue_vue_type_script_setup_true_lang-DLJ3rjid.js";import"./StacktraceViewer.vue_vue_type_style_index_0_scoped_7fdb99e3_lang-B8VJLqpg.js";import{_ as ae}from"./Pagination.vue_vue_type_script_setup_true_lang-Dw2mOa6S.js";import{a as oe,c as ne,M as se}from"./DashboardLayout.vue_vue_type_script_setup_true_lang-CjAASZmf.js";import{_ as le}from"./InputField.vue_vue_type_script_setup_true_lang-BrMCFGzf.js";import{c as U,d as re,i as f,z as E,q as ie,k as ce,C as de,j as L,w as l,o as I,b as o,e as s,u as n,g as V,t as w,p as ue,n as me,a as pe,m as ve,f as ge,R as F,K as fe}from"./index-BJM9FpXo.js";import{_ as N}from"./SelectField.vue_vue_type_script_setup_true_lang-l9nXAe77.js";import{_ as he,o as xe,n as _e,s as $}from"./TheForm.vue_vue_type_script_setup_true_lang-BcdpkkpR.js";import{u as ye}from"./issues-C0m3fSIl.js";import{f as W}from"./index-CaLwU_wJ.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-B9uLu0-5.js";import"./users-BNnsnLpB.js";import"./projects-CJzepl33.js";import"./platforms-D8ztvdxx.js";const ke=async(i,k)=>{const r=await D.get(`/projects/${i}/events`,{params:k});return{pagination:{from:r.from,to:r.to,total:r.total,links:r.links,current_page:r.current_page,data:r.data},events:r.data}},be=U(()=>[{key:"message",title:"Событие",cellClass:"whitespace-nowrap text-sm text-gray-500",maxWidth:"200px"},{key:"type",title:"Тип",maxWidth:"200px",truncate:!0},{key:"level",title:"Уровень",maxWidth:"80px"},{key:"count",title:"Количество",cellClass:"whitespace-nowrap text-sm text-gray-500",format:i=>i.toLocaleString(),maxWidth:"80px"},{key:"created_at",title:"Последнее",cellClass:"whitespace-nowrap text-sm text-gray-500",format:i=>W(i),maxWidth:"80px"},{key:"actions",title:"Действия",cellClass:"text-right"}]),Ce=[{key:"create-issue",label:"Создать задачу",icon:"heroicons:plus-circle",iconClass:"text-blue-500"},{key:"delete",label:"Удалить",icon:"heroicons:trash",iconClass:"text-red-500"}],Ee={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},Ie={class:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8"},Ve={class:"flex items-start space-x-3"},Se={class:"p-3 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl shadow-md"},Le={class:"flex items-center space-x-3 mt-2"},$e={class:"flex flex-wrap gap-3"},De={class:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"},je={class:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"},Re={class:"flex items-center space-x-3"},Oe={class:"min-w-0"},Fe={class:"text-sm font-medium text-gray-900 truncate max-w-md"},Ne={key:0,class:"text-xs text-gray-500 mt-1 truncate"},Ue={class:"text-sm text-gray-500 whitespace-nowrap"},We={class:"flex justify-start"},Pe={class:"flex justify-end gap-3 mt-5"},Te=re({__name:"Events",props:{slug:{}},setup(i){const k=ge(),r=ye(),S=f(!1),P=U(()=>{var e;return c.value.length?c.value[0].release==="unknown/unknown"?(e=c.value.find(t=>t.release!=="unknown/unknown"))==null?void 0:e.release:c.value[0].release:"Не указан"}),c=f([]),h=f({from:1,to:10,total:0,links:[],current_page:1,data:[]}),x=f(!1),T=f({}),d=E({title:"",priority:ee.Low,due_date:new Date().toDateString(),event_id:0}),A=xe({title:$(),priority:$(),due_date:$(),event_id:_e()}),p=E({total:0,totalChangedFor:"",changeDirection:"up"}),v=E({total:0,totalChangedFor:"",changeDirection:"up"}),_=E({total:0,errors:0,warnings:0,infos:0}),g=f({level:"",release:"",environment:"production"}),B=[{key:"",value:"Все"},{key:"error",value:"Ошибки"},{key:"warning",value:"Предупреждения"},{key:"info",value:"Информационные"}],M={error:"danger",warning:"warning",info:"primary"},q={error:"red",warning:"yellow",info:"blue",critical:"red",debug:"green"},z={error:"heroicons:exclamation-circle",warning:"heroicons:exclamation-triangle",info:"heroicons:information-circle",critical:"heroicons:information-circle",debug:"heroicons:information-circle"},H=e=>M[e]||"secondary",K=e=>q[e]||"gray",G=e=>z[e]||"heroicons:bell",J=({key:e,row:t})=>{switch(e){case"view":j(t.id);break;case"create-issue":x.value=!0,T.value=t,d.event_id=t.id;break;case"delete":Q(t.id);break}},Q=async e=>{if(confirm("Вы уверены, что хотите удалить это событие?"))try{await D.delete(`/events/${e}`),await y()}catch(t){console.error("Error deleting event:",t)}},j=e=>{k.push(F.EVENT.SHOW.replace(":id",e.toString()))},y=async()=>{S.value=!0;try{const{events:e,pagination:t}=await ke(i.slug,{per_page:10,page:h.value.current_page,level:g.value.level,release:g.value.release,environment:g.value.environment});c.value=e,h.value=t,_.total=e.length,_.errors=e.filter(u=>u.level==="error").length,_.warnings=e.filter(u=>u.level==="warning").length,_.infos=e.filter(u=>u.level==="info").length}catch(e){console.error("Error fetching events:",e)}finally{S.value=!1}},X=async()=>{try{const e=await r.createIssue(d);x.value=!1,await k.push(F.ISSUE.SHOW.replace(":id",e.id.toString())),fe.success("Задача успешно создана")}catch(e){console.error("Error creating issue:",e)}},Y=e=>{if(!e)return;const t=new URL(e).searchParams.get("page");t&&(h.value.current_page=parseInt(t),y())};ie(g.value,async()=>{h.value.current_page=1,await y()}),ce(async()=>{await y();const e=await D.get(`/projects/stats/${i.slug}/week`);p.total=e.events.count,p.totalChangedFor=e.events.trend_value,p.changeDirection=e.events.trend,v.total=e.errors.count,v.totalChangedFor=e.errors.trend_value,v.changeDirection=e.errors.trend});const Z=setInterval(y,3e4);return de(()=>{clearInterval(Z)}),(e,t)=>{const u=ue("RouterLink");return I(),L(oe,null,{default:l(()=>[o("div",Ee,[o("div",Ie,[o("div",Ve,[o("div",Se,[s(n(b),{icon:"heroicons:bell-alert",class:"h-8 w-8 text-white"})]),o("div",null,[t[7]||(t[7]=o("h1",{class:"text-2xl font-bold text-gray-900"},"События проекта",-1)),o("div",Le,[s(n(R),{variant:"secondary",class:"flex items-center"},{default:l(()=>{var a;return[s(n(b),{icon:"heroicons:computer-desktop",class:"mr-1 h-4 w-4"}),V(" "+w(((a=[...c.value].pop())==null?void 0:a.environment)??"Нет информации"),1)]}),_:1}),s(u,{to:`/projects/${e.slug}`,class:"text-sm text-indigo-600 hover:text-indigo-800 flex items-center"},{default:l(()=>[s(n(b),{icon:"heroicons:arrow-left",class:"mr-1 h-4 w-4"}),t[6]||(t[6]=V(" Назад к проекту "))]),_:1,__:[6]},8,["to"])])])]),o("div",$e,[s(n(N),{id:"level",modelValue:g.value.level,"onUpdate:modelValue":t[0]||(t[0]=a=>g.value.level=a),options:B,"option-label":"value","option-value":"key",placeholder:"Все уровни",class:"min-w-48",icon:"heroicons:filter"},null,8,["modelValue"])])]),o("div",De,[s(C,{title:"Всего событий",value:p.total,icon:"heroicons:chart-bar",trend:p.changeDirection,"trend-value":p.totalChangedFor},null,8,["value","trend","trend-value"]),s(C,{title:"Ошибки",value:v.total,icon:"heroicons:exclamation-circle",variant:"danger",trend:v.changeDirection,"trend-value":v.totalChangedFor},null,8,["value","trend","trend-value"]),s(C,{title:"Предупреждения",value:_.warnings.toLocaleString(),icon:"heroicons:exclamation-triangle",variant:"warning"},null,8,["value"]),s(C,{title:"Текущий релиз",value:P.value||0,icon:"heroicons:tag"},null,8,["value"])]),o("div",je,[t[8]||(t[8]=o("div",{class:"px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white"},[o("h2",{class:"text-lg font-semibold text-gray-900"},"Последние события")],-1)),c.value.length?(I(),L(n(ae),{key:0,columns:n(be),data:c.value,pagination:h.value,"is-loading":S.value,"row-key":"id","row-clickable":"",onRowClick:t[1]||(t[1]=a=>j(a.id)),onPageChange:Y,class:"rounded-none rounded-bl-lg rounded-br-lg","pagination-text":"событий"},{"cell-message":l(({row:a})=>{var m;return[o("div",Re,[o("div",{class:me(`text-${K(a.level)}-500`)},[s(n(b),{icon:G(a.level),class:"h-5 w-5"},null,8,["icon"])],2),o("div",Oe,[o("p",Fe,w(a.message),1),(m=a.metadata)!=null&&m.file?(I(),pe("p",Ne,w(a.metadata.file)+":"+w(a.metadata.line||"?"),1)):ve("",!0)])])]}),"cell-level":l(({value:a})=>[s(n(R),{variant:H(a),text:a},null,8,["variant","text"])]),"cell-timestamp":l(({value:a})=>[o("span",Ue,w(n(W)(a)),1)]),"cell-actions":l(({row:a})=>[o("span",We,[s(n(ne),{row:a,actions:n(Ce),onAction:J},null,8,["row","actions"])])]),_:1},8,["columns","data","pagination","is-loading"])):(I(),L(n(te),{key:1,title:"События отсутствуют",icon:"heroicons:bell-alert",description:"Пока что никаких событий нет"}))]),s(n(se),{"is-open":x.value,onClose:t[5]||(t[5]=a=>x.value=!1)},{title:l(()=>t[9]||(t[9]=[o("h2",{class:"text-xl font-bold text-gray-900 mb-2"},"Создать задачу",-1)])),content:l(()=>[s(n(he),{class:"space-y-6",schema:n(A),data:d,submit:X},{default:l(({errors:a})=>[s(n(le),{id:"title",modelValue:d.title,"onUpdate:modelValue":t[2]||(t[2]=m=>d.title=m),label:"Заголовок",placeholder:"Заголовок задачи",error:a==null?void 0:a.title,required:""},null,8,["modelValue","error"]),s(n(N),{id:"priority",modelValue:d.priority,"onUpdate:modelValue":t[3]||(t[3]=m=>d.priority=m),label:"Приоритет",placeholder:"Приоритет задачи",options:[{key:"low",value:"Низкий"},{key:"medium",value:"Средний"},{key:"high",value:"Высокий"},{key:"critical",value:"Критический"}],"option-label":"value","option-value":"key",required:"",error:a==null?void 0:a.priority},null,8,["modelValue","error"]),o("div",Pe,[s(n(O),{variant:"secondary",onClick:t[4]||(t[4]=m=>x.value=!1),class:"px-4 py-2"},{default:l(()=>t[10]||(t[10]=[V(" Отмена ")])),_:1,__:[10]}),s(n(O),{type:"submit",class:"px-4 py-2"},{default:l(()=>t[11]||(t[11]=[V(" Создать ")])),_:1,__:[11]})])]),_:1},8,["schema","data"])]),_:1},8,["is-open"])])]),_:1})}}}),rt=we(Te,[["__scopeId","data-v-ee3f4f61"]]);export{rt as default};
