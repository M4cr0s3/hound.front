import{i as I,c as G,d as J,k as u,A as Q,C as X,m as Y,D as Z,l as $,w as n,o as w,b as o,e as l,f as s,h as b,t as h,s as ee,p as te,a as ae,q as se,g as oe,R as U,K as le}from"./index-Dr8GC7C8.js";import{I as k}from"./iconify-nGeM3Ss7.js";import{_ as ne}from"./DataTable.vue_vue_type_script_setup_true_lang-CieHneHY.js";import{_ as R}from"./SelectField.vue_vue_type_script_setup_true_lang-CZeGnawA.js";import{a as re,c as ie,M as ce}from"./DashboardLayout.vue_vue_type_script_setup_true_lang-B3Mng-G2.js";import{_ as W}from"./InputField.vue_vue_type_script_setup_true_lang-Beax8uRS.js";import{_ as N}from"./Button.vue_vue_type_script_setup_true_lang-C1B6Yvt6.js";import"./index-BCqgpTI_.js";import{o as de,d as ue,s as E,n as me,_ as pe}from"./TheForm.vue_vue_type_script_setup_true_lang-5GcjAtG3.js";import{_ as O}from"./Badge.vue_vue_type_script_setup_true_lang-BnALEO-N.js";import{f as q}from"./index-bfLnkGmT.js";import{S as C}from"./StatCard-CTU-ahyX.js";import{u as ve}from"./issues-5CMUJcAp.js";import{_ as ge}from"./EmptyState.vue_vue_type_script_setup_true_lang-pS1QUvbm.js";import{_ as fe}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-Cqf0SSGI.js";import"./projects-CkGr_SGu.js";import"./platforms-D8ztvdxx.js";const xe=async(c,_)=>{const d=await I.get(`/projects/${c}/events`,{params:_});return{pagination:{from:d.from,to:d.to,total:d.total,links:d.links,current_page:d.current_page},events:d.data}},ye=G(()=>[{key:"message",title:"Событие",cellClass:"whitespace-nowrap text-sm text-gray-500",maxWidth:"200px"},{key:"type",title:"Тип",maxWidth:"200px",truncate:!0},{key:"level",title:"Уровень",maxWidth:"80px"},{key:"count",title:"Количество",cellClass:"whitespace-nowrap text-sm text-gray-500",format:c=>c.toLocaleString(),maxWidth:"80px"},{key:"created_at",title:"Последнее",cellClass:"whitespace-nowrap text-sm text-gray-500",format:c=>q(c),maxWidth:"80px"},{key:"actions",title:"Действия",cellClass:"text-right"}]),he=[{key:"create-issue",label:"Создать задачу",icon:"heroicons:plus-circle",iconClass:"text-blue-500"},{key:"delete",label:"Удалить",icon:"heroicons:trash",iconClass:"text-red-500"}],_e=de({event_id:me(),title:E(),description:E(),priority:E(),due_date:ue()}),we={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},be={class:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8"},ke={class:"flex items-start space-x-3"},Ce={class:"p-3 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl shadow-md"},Ve={class:"flex items-center space-x-3 mt-2"},$e={class:"flex flex-wrap gap-3"},Ee={class:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"},Ie={class:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"},Se={class:"flex items-center space-x-3"},Le={class:"min-w-0"},je={class:"text-sm font-medium text-gray-900 truncate max-w-md"},Ue={key:0,class:"text-xs text-gray-500 mt-1 truncate"},Re={class:"text-sm text-gray-500 whitespace-nowrap"},We={class:"flex justify-start"},Ne={class:"flex justify-end gap-3 mt-5"},Oe=J({__name:"Events",props:{slug:{}},setup(c){const _=oe(),d=ve(),V=u(!1),g=u([]),f=u({from:1,to:10,total:0,links:[],current_page:1}),x=u(!1),B=u({}),r=Q({title:"",description:"",priority:"low",due_date:new Date,event_id:""}),m=u({events:{},errors:{}}),S=u({total:0,errors:0,warnings:0,infos:0}),v=u({level:"",release:"",environment:"production"}),D=[{key:"",value:"Все"},{key:"error",value:"Ошибки"},{key:"warning",value:"Предупреждения"},{key:"info",value:"Информационные"}],M=a=>({error:"danger",warning:"warning",info:"primary"})[a]||"secondary",P=a=>({error:"red",warning:"yellow",info:"blue"})[a]||"gray",T=a=>({error:"heroicons:exclamation-circle",warning:"heroicons:exclamation-triangle",info:"heroicons:information-circle"})[a]||"heroicons:bell",A=({key:a,row:e})=>{switch(a){case"view":L(e.id);break;case"create-issue":x.value=!0,B.value=e,r.event_id=e.id;break;case"delete":H(e.id);break}},H=async a=>{if(confirm("Вы уверены, что хотите удалить это событие?"))try{await I.delete(`/events/${a}`),await y()}catch(e){console.error("Error deleting event:",e)}},L=a=>{_.push(U.EVENT.SHOW.replace(":id",a))},y=async()=>{V.value=!0;try{const{events:a,pagination:e}=await xe(c.slug,{per_page:10,page:f.value.current_page,level:v.value.level,release:v.value.release,environment:v.value.environment});g.value=a,f.value=e,S.value={total:a.length,errors:a.filter(p=>p.level==="error").length,warnings:a.filter(p=>p.level==="warning").length,infos:a.filter(p=>p.level==="info").length}}catch(a){console.error("Error fetching events:",a)}finally{V.value=!1}},K=async()=>{try{const a=await d.createIssue(r);x.value=!1,await _.push(U.ISSUE.SHOW.replace(":id",a.id)),le.success("Задача успешно создана")}catch(a){console.error("Error creating issue:",a)}},z=a=>{if(!a)return;const e=new URL(a).searchParams.get("page");e&&(f.value.current_page=parseInt(e),y())};X(v.value,async()=>{f.value.current_page=1,await y()}),Y(async()=>{await y(),m.value=await I.get(`/projects/stats/${c.slug}/week`)});const F=setInterval(y,3e4);return Z(()=>{clearInterval(F)}),(a,e)=>{const p=ee("RouterLink");return w(),$(re,null,{default:n(()=>{var j;return[o("div",we,[o("div",be,[o("div",ke,[o("div",Ce,[l(s(k),{icon:"heroicons:bell-alert",class:"h-8 w-8 text-white"})]),o("div",null,[e[8]||(e[8]=o("h1",{class:"text-2xl font-bold text-gray-900"},"События проекта",-1)),o("div",Ve,[l(s(O),{variant:"secondary",class:"flex items-center"},{default:n(()=>{var t;return[l(s(k),{icon:"heroicons:computer-desktop",class:"mr-1 h-4 w-4"}),b(" "+h(((t=[...g.value].pop())==null?void 0:t.environment)??"Нет информации"),1)]}),_:1}),l(p,{to:`/projects/${a.slug}`,class:"text-sm text-indigo-600 hover:text-indigo-800 flex items-center"},{default:n(()=>[l(s(k),{icon:"heroicons:arrow-left",class:"mr-1 h-4 w-4"}),e[7]||(e[7]=b(" Назад к проекту "))]),_:1},8,["to"])])])]),o("div",$e,[l(s(R),{id:"level",modelValue:v.value.level,"onUpdate:modelValue":e[0]||(e[0]=t=>v.value.level=t),options:D,"option-label":"value","option-value":"key",placeholder:"Все уровни",class:"min-w-48",icon:"heroicons:filter"},null,8,["modelValue"])])]),o("div",Ee,[l(C,{title:"Всего событий",value:m.value.events.count,icon:"heroicons:chart-bar",trend:m.value.events.trend,"trend-value":m.value.events.trend_value},null,8,["value","trend","trend-value"]),l(C,{title:"Ошибки",value:m.value.errors.count,icon:"heroicons:exclamation-circle",variant:"danger",trend:m.value.errors.trend,"trend-value":m.value.errors.trend_value},null,8,["value","trend","trend-value"]),l(C,{title:"Предупреждения",value:S.value.warnings.toLocaleString(),icon:"heroicons:exclamation-triangle",variant:"warning"},null,8,["value"]),l(C,{title:"Текущий релиз",value:((j=[...g.value].pop())==null?void 0:j.release)??"Нет информации",icon:"heroicons:tag"},null,8,["value"])]),o("div",Ie,[e[9]||(e[9]=o("div",{class:"px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white"},[o("h2",{class:"text-lg font-semibold text-gray-900"},"Последние события")],-1)),g.value.length?(w(),$(s(ne),{key:0,columns:s(ye),data:g.value,pagination:f.value,"is-loading":V.value,"row-key":"id","row-clickable":"",onRowClick:e[1]||(e[1]=t=>L(t.id)),onPageChange:z,class:"rounded-none rounded-bl-lg rounded-br-lg","pagination-text":"событий"},{"cell-message":n(({row:t})=>{var i;return[o("div",Se,[o("div",{class:te(`text-${P(t.level)}-500`)},[l(s(k),{icon:T(t.level),class:"h-5 w-5"},null,8,["icon"])],2),o("div",Le,[o("p",je,h(t.message),1),(i=t.metadata)!=null&&i.file?(w(),ae("p",Ue,h(t.metadata.file)+":"+h(t.metadata.line||"?"),1)):se("",!0)])])]}),"cell-level":n(({value:t})=>[l(s(O),{variant:M(t),text:t},null,8,["variant","text"])]),"cell-timestamp":n(({value:t})=>[o("span",Re,h(s(q)(t)),1)]),"cell-actions":n(({row:t})=>[o("span",We,[l(s(ie),{row:t,actions:s(he),onAction:A},null,8,["row","actions"])])]),_:1},8,["columns","data","pagination","is-loading"])):(w(),$(s(ge),{key:1,title:"События отсутствуют",icon:"heroicons:bell-alert",description:"Пока что никаких событий нет"}))]),l(s(ce),{"is-open":x.value,onClose:e[6]||(e[6]=t=>x.value=!1)},{title:n(()=>e[10]||(e[10]=[o("h2",{class:"text-xl font-bold text-gray-900 mb-2"},"Создать задачу",-1)])),content:n(()=>[l(s(pe),{class:"space-y-6",schema:s(_e),data:r,submit:K},{default:n(({errors:t})=>[l(s(W),{id:"title",modelValue:r.title,"onUpdate:modelValue":e[2]||(e[2]=i=>r.title=i),label:"Заголовок",placeholder:"Заголовок задачи",error:t==null?void 0:t.title,required:""},null,8,["modelValue","error"]),l(s(W),{id:"description",modelValue:r.description,"onUpdate:modelValue":e[3]||(e[3]=i=>r.description=i),label:"Описание",placeholder:"Описание задачи",required:"",error:t==null?void 0:t.description},null,8,["modelValue","error"]),l(s(R),{id:"priority",modelValue:r.priority,"onUpdate:modelValue":e[4]||(e[4]=i=>r.priority=i),label:"Приоритет",placeholder:"Приоритет задачи",options:[{key:"low",value:"Низкий"},{key:"medium",value:"Средний"},{key:"high",value:"Высокий"},{key:"critical",value:"Критический"}],"option-label":"value","option-value":"key",required:"",error:t==null?void 0:t.priority},null,8,["modelValue","error"]),o("div",Ne,[l(s(N),{variant:"secondary",onClick:e[5]||(e[5]=i=>x.value=!1),class:"px-4 py-2"},{default:n(()=>e[11]||(e[11]=[b(" Отмена ")])),_:1}),l(s(N),{type:"submit",class:"px-4 py-2"},{default:n(()=>e[12]||(e[12]=[b(" Создать ")])),_:1})])]),_:1},8,["schema","data"])]),_:1},8,["is-open"])])]}),_:1})}}}),tt=fe(Oe,[["__scopeId","data-v-43d7146d"]]);export{tt as default};
