import{i as D,c as U,d as Z,k as f,B as b,x as ee,m as te,E as ae,l as L,w as l,o as C,b as n,e as s,f as o,h as E,t as w,s as ne,p as oe,a as se,q as le,g as re,R as j,K as ie}from"./index-B605mWSS.js";import{I as ce}from"./types-CpYKjTMI.js";import{_ as de}from"./EmptyState.vue_vue_type_script_setup_true_lang-6tWArOav.js";import{I}from"./iconify-e9sR0ZFq.js";import{S as V}from"./StatCard-B-ZXmqgC.js";import{_ as O}from"./Badge.vue_vue_type_script_setup_true_lang-BJ0lmBAF.js";import{_ as F}from"./Button.vue_vue_type_script_setup_true_lang-BvWJDmF7.js";import"./StacktraceViewer.vue_vue_type_style_index_0_scoped_8568d111_lang-OogGfIpQ.js";import{_ as ue}from"./Pagination.vue_vue_type_script_setup_true_lang-DG5CJXSe.js";import{a as me,c as pe,M as ve}from"./DashboardLayout.vue_vue_type_script_setup_true_lang-BKjXbmz5.js";import{_ as ge}from"./InputField.vue_vue_type_script_setup_true_lang-DBN7DNb5.js";import{_ as N}from"./SelectField.vue_vue_type_script_setup_true_lang-Dsjyj-fN.js";import{o as fe,d as xe,s as $,n as he,_ as ye}from"./TheForm.vue_vue_type_script_setup_true_lang-CCNSZ3Rc.js";import{u as _e}from"./issues-jFpWbkm-.js";import{f as W}from"./index-BPW3n-1W.js";import{_ as we}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./index-p83CCQy-.js";import"./projects-DhOs14FM.js";import"./platforms-D8ztvdxx.js";const ke=async(i,k)=>{const r=await D.get(`/projects/${i}/events`,{params:k});return{pagination:{from:r.from,to:r.to,total:r.total,links:r.links,current_page:r.current_page,data:r.data},events:r.data}},be=fe({event_id:he(),title:$(),description:$(),priority:$(),due_date:xe()}),Ce=U(()=>[{key:"message",title:"Событие",cellClass:"whitespace-nowrap text-sm text-gray-500",maxWidth:"200px"},{key:"type",title:"Тип",maxWidth:"200px",truncate:!0},{key:"level",title:"Уровень",maxWidth:"80px"},{key:"count",title:"Количество",cellClass:"whitespace-nowrap text-sm text-gray-500",format:i=>i.toLocaleString(),maxWidth:"80px"},{key:"created_at",title:"Последнее",cellClass:"whitespace-nowrap text-sm text-gray-500",format:i=>W(i),maxWidth:"80px"},{key:"actions",title:"Действия",cellClass:"text-right"}]),Ee=[{key:"create-issue",label:"Создать задачу",icon:"heroicons:plus-circle",iconClass:"text-blue-500"},{key:"delete",label:"Удалить",icon:"heroicons:trash",iconClass:"text-red-500"}],Ie={class:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"},Ve={class:"flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8"},Se={class:"flex items-start space-x-3"},Le={class:"p-3 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl shadow-md"},$e={class:"flex items-center space-x-3 mt-2"},De={class:"flex flex-wrap gap-3"},Re={class:"grid grid-cols-1 md:grid-cols-4 gap-6 mb-8"},je={class:"bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden"},Oe={class:"flex items-center space-x-3"},Fe={class:"min-w-0"},Ne={class:"text-sm font-medium text-gray-900 truncate max-w-md"},Ue={key:0,class:"text-xs text-gray-500 mt-1 truncate"},We={class:"text-sm text-gray-500 whitespace-nowrap"},Be={class:"flex justify-start"},Pe={class:"flex justify-end gap-3 mt-5"},Te=Z({__name:"Events",props:{slug:{}},setup(i){const k=re(),r=_e(),S=f(!1),B=U(()=>{var e;return c.value.length?c.value[0].release==="unknown/unknown"?(e=c.value.find(t=>t.release!=="unknown/unknown"))==null?void 0:e.release:c.value[0].release:"Не указан"}),c=f([]),x=f({from:1,to:10,total:0,links:[],current_page:1,data:[]}),h=f(!1),P=f({}),d=b({title:"",priority:ce.Low,due_date:new Date().toDateString(),event_id:0}),p=b({total:0,totalChangedFor:"",changeDirection:"up"}),v=b({total:0,totalChangedFor:"",changeDirection:"up"}),y=b({total:0,errors:0,warnings:0,infos:0}),g=f({level:"",release:"",environment:"production"}),T=[{key:"",value:"Все"},{key:"error",value:"Ошибки"},{key:"warning",value:"Предупреждения"},{key:"info",value:"Информационные"}],A={error:"danger",warning:"warning",info:"primary"},M={error:"red",warning:"yellow",info:"blue"},q={error:"heroicons:exclamation-circle",warning:"heroicons:exclamation-triangle",info:"heroicons:information-circle"},H=e=>A[e]||"secondary",K=e=>M[e]||"gray",z=e=>q[e]||"heroicons:bell",G=({key:e,row:t})=>{switch(e){case"view":R(t.id);break;case"create-issue":h.value=!0,P.value=t,d.event_id=t.id;break;case"delete":J(t.id);break}},J=async e=>{if(confirm("Вы уверены, что хотите удалить это событие?"))try{await D.delete(`/events/${e}`),await _()}catch(t){console.error("Error deleting event:",t)}},R=e=>{k.push(j.EVENT.SHOW.replace(":id",e.toString()))},_=async()=>{S.value=!0;try{const{events:e,pagination:t}=await ke(i.slug,{per_page:10,page:x.value.current_page,level:g.value.level,release:g.value.release,environment:g.value.environment});c.value=e,x.value=t,y.total=e.length,y.errors=e.filter(u=>u.level==="error").length,y.warnings=e.filter(u=>u.level==="warning").length,y.infos=e.filter(u=>u.level==="info").length}catch(e){console.error("Error fetching events:",e)}finally{S.value=!1}},Q=async()=>{try{const e=await r.createIssue(d);h.value=!1,await k.push(j.ISSUE.SHOW.replace(":id",e.id.toString())),ie.success("Задача успешно создана")}catch(e){console.error("Error creating issue:",e)}},X=e=>{if(!e)return;const t=new URL(e).searchParams.get("page");t&&(x.value.current_page=parseInt(t),_())};ee(g.value,async()=>{x.value.current_page=1,await _()}),te(async()=>{await _();const e=await D.get(`/projects/stats/${i.slug}/week`);p.total=e.events.count,p.totalChangedFor=e.events.trend_value,p.changeDirection=e.events.trend,v.total=e.errors.count,v.totalChangedFor=e.errors.trend_value,v.changeDirection=e.errors.trend});const Y=setInterval(_,3e4);return ae(()=>{clearInterval(Y)}),(e,t)=>{const u=ne("RouterLink");return C(),L(me,null,{default:l(()=>[n("div",Ie,[n("div",Ve,[n("div",Se,[n("div",Le,[s(o(I),{icon:"heroicons:bell-alert",class:"h-8 w-8 text-white"})]),n("div",null,[t[7]||(t[7]=n("h1",{class:"text-2xl font-bold text-gray-900"},"События проекта",-1)),n("div",$e,[s(o(O),{variant:"secondary",class:"flex items-center"},{default:l(()=>{var a;return[s(o(I),{icon:"heroicons:computer-desktop",class:"mr-1 h-4 w-4"}),E(" "+w(((a=[...c.value].pop())==null?void 0:a.environment)??"Нет информации"),1)]}),_:1}),s(u,{to:`/projects/${e.slug}`,class:"text-sm text-indigo-600 hover:text-indigo-800 flex items-center"},{default:l(()=>[s(o(I),{icon:"heroicons:arrow-left",class:"mr-1 h-4 w-4"}),t[6]||(t[6]=E(" Назад к проекту "))]),_:1},8,["to"])])])]),n("div",De,[s(o(N),{id:"level",modelValue:g.value.level,"onUpdate:modelValue":t[0]||(t[0]=a=>g.value.level=a),options:T,"option-label":"value","option-value":"key",placeholder:"Все уровни",class:"min-w-48",icon:"heroicons:filter"},null,8,["modelValue"])])]),n("div",Re,[s(V,{title:"Всего событий",value:p.total,icon:"heroicons:chart-bar",trend:p.changeDirection,"trend-value":p.totalChangedFor},null,8,["value","trend","trend-value"]),s(V,{title:"Ошибки",value:v.total,icon:"heroicons:exclamation-circle",variant:"danger",trend:v.changeDirection,"trend-value":v.totalChangedFor},null,8,["value","trend","trend-value"]),s(V,{title:"Предупреждения",value:y.warnings.toLocaleString(),icon:"heroicons:exclamation-triangle",variant:"warning"},null,8,["value"]),s(V,{title:"Текущий релиз",value:B.value||0,icon:"heroicons:tag"},null,8,["value"])]),n("div",je,[t[8]||(t[8]=n("div",{class:"px-6 py-5 border-b border-gray-100 bg-gradient-to-r from-gray-50 to-white"},[n("h2",{class:"text-lg font-semibold text-gray-900"},"Последние события")],-1)),c.value.length?(C(),L(o(ue),{key:0,columns:o(Ce),data:c.value,pagination:x.value,"is-loading":S.value,"row-key":"id","row-clickable":"",onRowClick:t[1]||(t[1]=a=>R(a.id)),onPageChange:X,class:"rounded-none rounded-bl-lg rounded-br-lg","pagination-text":"событий"},{"cell-message":l(({row:a})=>{var m;return[n("div",Oe,[n("div",{class:oe(`text-${K(a.level)}-500`)},[s(o(I),{icon:z(a.level),class:"h-5 w-5"},null,8,["icon"])],2),n("div",Fe,[n("p",Ne,w(a.message),1),(m=a.metadata)!=null&&m.file?(C(),se("p",Ue,w(a.metadata.file)+":"+w(a.metadata.line||"?"),1)):le("",!0)])])]}),"cell-level":l(({value:a})=>[s(o(O),{variant:H(a),text:a},null,8,["variant","text"])]),"cell-timestamp":l(({value:a})=>[n("span",We,w(o(W)(a)),1)]),"cell-actions":l(({row:a})=>[n("span",Be,[s(o(pe),{row:a,actions:o(Ee),onAction:G},null,8,["row","actions"])])]),_:1},8,["columns","data","pagination","is-loading"])):(C(),L(o(de),{key:1,title:"События отсутствуют",icon:"heroicons:bell-alert",description:"Пока что никаких событий нет"}))]),s(o(ve),{"is-open":h.value,onClose:t[5]||(t[5]=a=>h.value=!1)},{title:l(()=>t[9]||(t[9]=[n("h2",{class:"text-xl font-bold text-gray-900 mb-2"},"Создать задачу",-1)])),content:l(()=>[s(o(ye),{class:"space-y-6",schema:o(be),data:d,submit:Q},{default:l(({errors:a})=>[s(o(ge),{id:"title",modelValue:d.title,"onUpdate:modelValue":t[2]||(t[2]=m=>d.title=m),label:"Заголовок",placeholder:"Заголовок задачи",error:a==null?void 0:a.title,required:""},null,8,["modelValue","error"]),s(o(N),{id:"priority",modelValue:d.priority,"onUpdate:modelValue":t[3]||(t[3]=m=>d.priority=m),label:"Приоритет",placeholder:"Приоритет задачи",options:[{key:"low",value:"Низкий"},{key:"medium",value:"Средний"},{key:"high",value:"Высокий"},{key:"critical",value:"Критический"}],"option-label":"value","option-value":"key",required:"",error:a==null?void 0:a.priority},null,8,["modelValue","error"]),n("div",Pe,[s(o(F),{variant:"secondary",onClick:t[4]||(t[4]=m=>h.value=!1),class:"px-4 py-2"},{default:l(()=>t[10]||(t[10]=[E(" Отмена ")])),_:1}),s(o(F),{type:"submit",class:"px-4 py-2"},{default:l(()=>t[11]||(t[11]=[E(" Создать ")])),_:1})])]),_:1},8,["schema","data"])]),_:1},8,["is-open"])])]),_:1})}}}),rt=we(Te,[["__scopeId","data-v-645451a8"]]);export{rt as default};
